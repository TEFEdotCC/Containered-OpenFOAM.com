#!/bin/bash

#
[ -n "$SOURCE_BRANCH" ]  || SOURCE_BRANCH=$(git symbolic-ref -q --short HEAD)
[ -n "$GIT_SHA1" ]       || GIT_SHA1=$(git rev-parse -q HEAD)

#
#
export OPENFOAM_GIT_URL="https://develop.openfoam.com/Development/openfoam.git"
export OPENFOAM_THIRDPARTY_GIT_URL="https://develop.openfoam.com/Development/ThirdParty-common.git"
export OPENFOAM_VERSION="$SOURCE_BRANCH"
export IMAGE_VERSION="$OPENFOAM_VERSION"

if [ "$OPENFOAM_VERSION" = "develop" ]; then
  #
  # branch : develop
  #   mostly stable branch for next release.
  export OPENFOAM_GIT_BRANCH="develop"
  export OPENFOAM_THIRDPARTY_GIT_BRANCH="develop"
  export IMAGE_VERSION="dev"

elif [ $(git ls-remote --heads $OPENFOAM_GIT_URL "maintenance-$OPENFOAM_VERSION" | wc -l) -eq 1 ]; then
  #
  # branch : maintenance-...
  #   previous releases with bug fixes
  export OPENFOAM_GIT_BRANCH="maintenance-$OPENFOAM_VERSION"
  export OPENFOAM_THIRDPARTY_GIT_BRANCH="$OPENFOAM_VERSION"

else
  #
  # branch : master
  #   last releases with bug fixes, should be mostly stable
  export OPENFOAM_GIT_BRANCH="master"
  export OPENFOAM_THIRDPARTY_GIT_BRANCH="main"
  export IMAGE_VERSION="latest"
fi

#
# Set defaults for build arguments 
[ -n "$SOURCE_TYPE" ]        || SOURCE_TYPE=git
[ -n "$DOCKERFILE_PATH" ]    || DOCKERFILE_PATH=.
[ -n "$IMAGE_NAME" ]         || IMAGE_NAME=tefe/openfoam.com:$IMAGE_VERSION
