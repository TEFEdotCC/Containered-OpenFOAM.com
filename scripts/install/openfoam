#!/bin/bash -xe

export WM_NCOMPPROCS=$(grep -c ^processor /proc/cpuinfo)

#
export ADIOS2_VERSION_MAJOR=2
export ADIOS2_VERSION_MINOR=4
export ADIOS2_VERSION_SUFFIX=0
export ADIOS2_VERSION="${ADIOS2_VERSION_MAJOR}.${ADIOS2_VERSION_MINOR}.${ADIOS2_VERSION_SUFFIX}"
export FFTW_VERSION=3.3.7
export PETSC_VERSION=3.13.2
export SCOTCH_VERSION=6.0.9
export KAHIP_VERSION=2.12

export preCICE_VERSION=2.1.0

# ------------------------------------------------------------------------------
#
export OPENFOAM_DIR="/opt/openfoam"
export OPENFOAM_THIRDPARTY_DIR="$OPENFOAM_DIR/ThirdParty"

# ------------------------------------------------------------------------------
#
export ADIOS2_GIT_URL="https://github.com/ornladios/ADIOS2.git"
export ADIOS2_GIT_BRANCH="release_${ADIOS2_VERSION_MAJOR}${ADIOS2_VERSION_MINOR}"
export ADIOS2_DIR="${OPENFOAM_THIRDPARTY_DIR}/ADIOS2-${ADIOS2_VERSION}"

#export FFTW_GIT_URL="0"
#export FFTW_GIT_BRANCH="0"
#export FFTW_DIR="${OPENFOAM_THIRDPARTY_DIR}/fftw-${FFTW_VERSION}"

export PETSC_GIT_URL="https://gitlab.com/petsc/petsc.git"
export PETSC_GIT_BRANCH="v${PETSC_VERSION}"
#export PETSC_DIR="${OPENFOAM_THIRDPARTY_DIR}/petsc_${PETSC_VERSION}"
#export PETSC_DIR=${OPENFOAM_THIRDPARTY_DIR}/petsc-${PETSC_VERSION}
#export PETSC_ARCH=linux-gnu

#export SCOTCH_GIT_URL="https://gitlab.inria.fr/scotch/scotch.git"
#export SCOTCH_GIT_BRANCH="v${SCOTCH_VERSION}"
#export SCOTCH_DIR="${OPENFOAM_THIRDPARTY_DIR}/scotch_${SCOTCH_VERSION}"

export KAHIP_GIT_URL="https://github.com/KaHIP/KaHIP.git"
export KAHIP_GIT_BRANCH="v${KAHIP_VERSION}"
export KAHIP_DIR="${OPENFOAM_THIRDPARTY_DIR}/kahip-${KAHIP_VERSION}"

export preCICE_BUILD_DIR='/opt/preCICE'
export PRECICE_ROOT="${preCICE_BUILD_DIR}/precice-${preCICE_VERSION}"

# ------------------------------------------------------------------------------
# load sources
git clone --branch $OPENFOAM_GIT_BRANCH            $OPENFOAM_GIT_URL            $OPENFOAM_DIR
git clone --branch $OPENFOAM_THIRDPARTY_GIT_BRANCH $OPENFOAM_THIRDPARTY_GIT_URL $OPENFOAM_THIRDPARTY_DIR

cd $OPENFOAM_DIR
git submodule init

echo ". $OPENFOAM_DIR/etc/bashrc" >> /etc/profile.d/openfoam.sh

#
git clone --branch ${ADIOS2_GIT_BRANCH} ${ADIOS2_GIT_URL} ${ADIOS2_DIR}
#git clone --branch ${SCOTCH_GIT_BRANCH} ${SCOTCH_GIT_URL} ${SCOTCH_DIR}
#git clone --branch ${PETSC_GIT_BRANCH}  ${PETSC_GIT_URL}  ${PETSC_DIR}

# KaHIP
git clone --branch ${KAHIP_GIT_BRANCH} ${KAHIP_GIT_URL} ${KAHIP_DIR}

# put petsc to third party
#cd ${OPENFOAM_THIRDPARTY_DIR}
#wget -q http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-lite-${PETSC_VERSION}.tar.gz
#tar -xzvf petsc-lite-${PETSC_VERSION}.tar.gz
#rm -f petsc-lite-${PETSC_VERSION}.tar.gz

#echo "export PETSC_DIR=${PETSC_DIR}" >> /etc/profile.d/PETSc.sh
#echo "export PETSC_ARCH=${PETSC_ARCH}" >> /etc/profile.d/PETSc.sh
#chmod +x /etc/profile.d/PETSc.sh
#
#cd ${PETSC_DIR}
#python setup.py install

# put fftw to third party
#cd ${OPENFOAM_THIRDPARTY_DIR}
#wget -q http://www.fftw.org/${FFTW_DIR}.tar.gz
#tar -xzvf ${FFTW_DIR}.tar.gz
#rm -f ${FFTW_DIR}.tar.gz

# ------------------------------------------------------------------------------
# build openfoam

# ensure label size of 64 bit
sed -ie  's|WM_LABEL_SIZE=32|WM_LABEL_SIZE=64|' ${OPENFOAM_DIR}/etc/bashrc

# config env
. /etc/profile.d/openfoam.sh || echo "skip errors."

#
cd ${OPENFOAM_THIRDPARTY_DIR}
./makeAdios2
./makeKAHIP
#./makePETSC
#./makeSCOTCH
#./makeFFTW

#
cd ${OPENFOAM_DIR}
./Allwmake -j -s -q -a

# ------------------------------------------------------------------------------
# add preCICE

mkdir -p ${preCICE_BUILD_DIR}
cd ${preCICE_BUILD_DIR}
wget -q https://github.com/precice/precice/archive/v${preCICE_VERSION}.tar.gz
tar -xzvf v${preCICE_VERSION}.tar.gz
rm -f v${preCICE_VERSION}.tar.gz
mkdir -p ${PRECICE_ROOT}/build && cd ${PRECICE_ROOT}/build

echo "export PRECICE_ROOT=${PRECICE_ROOT}" >> /etc/profile.d/preCICE.sh
chmod +x /etc/profile.d/preCICE.sh

# TODO: PRECICE_PETScMapping=off because of fedora petsc-devel will crash the configuration routine.
cmake                                                                           \
  -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Release                             \
  -DPRECICE_MPICommunication=ON                                                 \
  -DMPI_CXX_COMPILER=/usr/lib64/openmpi/bin/mpicxx                              \
  -DMPI_C_COMPILER=/usr/lib64/openmpi/bin/mpicc                                 \
  -DMPI_Fortran_COMPILER=/usr/lib64/openmpi/bin/mpifort                         \
  -DPRECICE_PETScMapping=off                                                    \
  ..

make -j$(nproc)
make install && make clean && rm -rf *

# ------------------------------------------------------------------------------
# preCICE adapter
preCICE_adapter_BUILD_DIR=${preCICE_BUILD_DIR}
#preCICE_adapter_of_GIT_URL='https://github.com/precice/openfoam-adapter.git'
preCICE_adapter_of_GIT_URL='https://github.com/TEFEdotCC/openfoam-adapter.git'

#git clone ${preCICE_adapter_of_GIT_URL} ${preCICE_adapter_BUILD_DIR}/openfoam-adapter
git clone --branch CHT_WallHeatFlux ${preCICE_adapter_of_GIT_URL} ${preCICE_adapter_BUILD_DIR}/openfoam-adapter

cd ${preCICE_adapter_BUILD_DIR}/openfoam-adapter
sed -ie "s|ADAPTER_WMAKE_OPTIONS=\"|ADAPTER_WMAKE_OPTIONS=\"-j |" Allwmake
#sed -ie 's|-DADAPTER_DEBUG_MODE| |' Allwmake
sed -ie 's|${FOAM_USER_LIBBIN}|${FOAM_EXT_LIBBIN}|' Allwmake

./Allwmake
./Allclean

# ------------------------------------------------------------------------------

# cleanup openfoam
#cd ${OPENFOAM_THIRDPARTY_DIR}
#./Allclean
#cd ${OPENFOAM_DIR}
#./Allclean
#find -name '*.o' | xargs rm
#find -name '*.dep' | xargs rm
#rm -rf build/*
